<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solvora AI — Prototype (HTML) — Robust Loader & Manual Fallback</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#4f46e5;--muted:#98a1b3;--glass:rgba(255,255,255,0.03)}
    html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;color:#e6eef8;background:linear-gradient(180deg,#071028 0%, #071224 100%);} 
    .app{max-width:980px;margin:28px auto;padding:20px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 6px 30px rgba(2,6,23,0.7)}
    header{display:flex;align-items:center;gap:12px}
    header h1{margin:0;font-size:20px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px;margin-top:18px}
    .card{background:var(--card);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    .uploader{display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;padding:18px;border-radius:8px;background:var(--glass);min-height:320px}
    .buttons{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:linear-gradient(90deg,var(--accent),#06b6d4);color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .preview img{max-width:100%;border-radius:8px}
    .results{max-height:560px;overflow:auto}
    .section-title{font-size:13px;color:var(--muted);margin-bottom:8px}
    .dropzone{width:100%;border:2px dashed rgba(255,255,255,0.03);padding:18px;border-radius:8px;text-align:center;color:var(--muted)}
    pre{background:#071126;padding:12px;border-radius:8px;color:#d8e7ff;white-space:pre-wrap}
    .loader{display:inline-block;height:14px;width:14px;border-radius:50%;border:3px solid rgba(255,255,255,0.08);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hint{font-size:13px;color:var(--muted)}
    footer{margin-top:12px;font-size:12px;color:var(--muted)}
    .step{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));padding:10px;border-radius:8px;margin-bottom:8px}
    .camera-preview{width:100%;height:240px;background:#061022;border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--muted);position:relative}
    .manual-area{display:flex;flex-direction:column;gap:8px}
    textarea {width:100%;min-height:120px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#071126;color:#e6eef8}
    @media(max-width:920px){.grid{grid-template-columns:1fr;}.camera-preview{height:180px}}
  </style>
</head>

<body>
  <div class="app">
    <header>
      <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 24 24' fill='none' stroke='%23ffffff'><rect x='3' y='3' width='18' height='18' rx='4' ry='4' stroke-width='1.5'/><path d='M8 14s1-2 4-2 4 2 4 2' stroke-width='1.5'/></svg>" alt="logo" style="filter:drop-shadow(0 6px 12px rgba(79,70,229,0.15))">
      <div>
        <h1>Solvora AI — Problem-scan & Solve (Robust Prototype)</h1>
        <div style="color:var(--muted);font-size:13px">Uploads + camera. Robust loader with multi-CDN fallback. If external libraries can't be fetched (sandboxed environment), a manual paste fallback and limited local solver will be available.</div>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <div class="section-title">Upload or capture problem</div>
        <div class="uploader">
          <div class="dropzone" id="dropzone">Drop an image here or click Upload</div>
          <div class="buttons">
            <input id="fileInput" type="file" accept="image/*" style="display:none">
            <button class="btn" id="uploadBtn">Upload image</button>
            <button class="btn ghost" id="cameraBtn">Use camera</button>
            <button class="btn ghost" id="clearBtn">Clear</button>
          </div>

          <div class="camera-preview" id="cameraPreview" style="display:none">
            <video id="video" autoplay playsinline style="width:100%;height:100%;object-fit:cover;border-radius:8px"></video>
            <button class="btn" id="snapBtn" style="position:absolute;bottom:12px;left:50%;transform:translateX(-50%);">Snap</button>
          </div>

          <div class="preview" id="previewArea" style="width:100%"></div>

          <div class="hint">Tip: For best OCR keep the problem well-lit and the image straight. The prototype handles typed math best. If OCR fails, use the "Paste extracted text" fallback below.</div>

          <div class="manual-area" style="width:100%;margin-top:10px">
            <label style="font-size:13px;color:var(--muted)">Paste extracted text (if OCR or network failed):</label>
            <textarea id="manualText" placeholder="e.g. 2x + 5 = 9 or sin(30) + 5^2"></textarea>
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button class="btn ghost" id="pasteSolveBtn">Solve pasted text</button>
              <button class="btn" id="tryReloadBtn">Retry loading libraries</button>
            </div>
          </div>

        </div>
      </div>

      <div class="card results">
        <div class="section-title">Solvora AI Output</div>
        <div id="status" style="margin-bottom:8px;color:var(--muted)">Initializing loader...</div>
        <div id="extractedText"></div>
        <div id="analysis"></div>
        <div id="solution"></div>
        <footer>Prototype: attempts to use Tesseract.js + mathjs + KaTeX when available. If not, manual fallback will let you paste text and use a limited local solver. No images leave your device unless you choose to upload them to a server.</footer>
      </div>
    </div>
  </div>

<script>
  // ----------------- DOM helpers -----------------
  function id(x){return document.getElementById(x)}
  const dropzone = id('dropzone');
  const uploadBtn = id('uploadBtn');
  const fileInput = id('fileInput');
  const previewArea = id('previewArea');
  const extractedText = id('extractedText');
  const analysis = id('analysis');
  const solution = id('solution');
  const clearBtn = id('clearBtn');
  const manualText = id('manualText');
  const pasteSolveBtn = id('pasteSolveBtn');
  const tryReloadBtn = id('tryReloadBtn');
  const status = id('status');

    async function uploadImage() {
    const fileInput = document.getElementById("imageInput");
    const file = fileInput.files[0];

    if (!file) {
        alert("Please select an image first!");
        return;
    }

    const formData = new FormData();
    formData.append("image", file);

    try {
        const res = await fetch("http://192.168.101.9:3000/ocr", {
            method: "POST",
            body: formData
        });

        const data = await res.json();

        document.getElementById("output").innerText = data.text || "No text found.";
    } catch (e) {
        document.getElementById("output").innerText =
            "❌ Failed to connect to backend.";
        console.error(e);
    }
}

  // ----------------- Upload & Drag handling -----------------
  ['dragenter','dragover','dragleave','drop'].forEach(evt => dropzone.addEventListener(evt, e=>{e.preventDefault();e.stopPropagation();}))
  dropzone.addEventListener('drop', async (e)=>{
    const f = e.dataTransfer.files && e.dataTransfer.files[0]; if(f) handleFile(f);
  });

  uploadBtn.addEventListener('click', ()=>fileInput.click());
  fileInput.addEventListener('change', ()=>{ if(fileInput.files[0]) handleFile(fileInput.files[0]); });
  clearBtn.addEventListener('click', clearAll);

  pasteSolveBtn.addEventListener('click', ()=>{
    const t = manualText.value.trim(); 
    if(!t){ alert('Paste some text first'); return }
    extractedText.innerHTML = '<div class="section-title">Extracted text (manual)</div><pre>'+escapeHtml(t)+'</pre>';
    analyzeText(t);
  });

  function clearAll(){
    previewArea.innerHTML=''; 
    extractedText.innerHTML=''; 
    analysis.innerHTML=''; 
    solution.innerHTML='';
    manualText.value=''; 
    status.innerText='Ready — upload an image to begin.';
  }

  // ----------------- File Handler -----------------
  async function handleFile(file){
    clearAll();
    status.innerHTML = 'Uploading to Solvora backend... <span class="loader"></span>';
    const img = document.createElement('img'); 
    img.style.maxHeight='320px'; 
    img.src = URL.createObjectURL(file);
    previewArea.appendChild(img);

    try {
      const formData = new FormData();
      formData.append('image', file);

      const res = await fetch('https://solvora-ai.onrender.com/ocr', {
        method: 'POST',
        body: formData
      });

      if(!res.ok) throw new Error('Backend error: '+res.status);
      const data = await res.json();
      const text = data.text?.trim() || '[no text detected]';

      extractedText.innerHTML = '<div class="section-title">Extracted text</div><pre>'+escapeHtml(text)+'</pre>';
      status.innerText = 'OCR complete via backend. Analyzing...';
      analyzeText(text);

    } catch(err) {
      console.error(err);
      status.innerText = 'OCR failed: '+err.message+' — use paste fallback.';
    }
  }


  // ----------------- Analysis & Solving -----------------
  function escapeHtml(s){return String(s).replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"})[c])}

  function analyzeText(text){
    const t = String(text).trim();
    if(!t){
      analysis.innerHTML='<div class="section-title">Analysis</div><div class="hint">No readable text found.</div>';
      return;
    }

    const mathIndicators = /[0-9]|\+|\-|\*|\/|=|x|\^|sqrt|sin|cos|tan|log|ln|integral|\.|\(|\)/i;
    const containsMath = mathIndicators.test(t);
    analysis.innerHTML = '<div class="section-title">Analysis</div><div>Detected math-like content: <strong>'+(containsMath? 'Yes':'No')+'</strong></div>';

    if(containsMath){ 
      try { solveMathFromText(t) } 
      catch(e){ 
        solution.innerHTML = '<div class="section-title">Solution</div><pre>Failed: '+escapeHtml(e.message)+'</pre>'; 
      }
    } else {
      solution.innerHTML = '<div class="section-title">Solution</div><div class="hint">Looks like plain text. OCR successful — for solving integrate AI.</div>';
    }
  }

  // Simple math solver
  function solveMathFromText(t){
    solution.innerHTML = '<div class="section-title">Solution</div><div>Processing... <span class="loader"></span></div>';
    setTimeout(()=>{
      try{
        const expr = t.split('\n')[0].replace(/÷/g,'/').replace(/×/g,'*');
        const value = safeEval(expr);
        solution.innerHTML = '<div class="section-title">Solution</div><pre>'+expr+' = '+value+'</pre>';
      }catch(e){
        solution.innerHTML = '<div class="section-title">Solution</div><pre>Could not solve: '+e.message+'</pre>';
      }
    },300);
  }

  function safeEval(expr){
    const cleaned = expr.replace(/[^0-9+\-*/().%^]/g,'');
    // eslint-disable-next-line no-new-func
    return Function('"use strict";return ('+cleaned+')')();
  }

  window.addEventListener('load', ()=>{
    status.innerText = 'Ready — upload an image or paste text.';
  });
 </script>

</body>
</html>